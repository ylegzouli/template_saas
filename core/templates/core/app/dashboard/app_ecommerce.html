{% block content %}
{% load static %}

<div class="shadow-sm bg-white rounded-sm">
    <div class="relative overflow-x-auto rounded-lg">

        <header class="z-40 items-center w-full h-12 bg-white shadow-sm dark:bg-gray-700 rounded-s mb-4">
            <!-- Existing search input and buttons -->
            <div class="relative z-20 flex flex-col justify-center h-full p-2 mx-auto flex-center">
                <form id="searchForm" hx-get="/app/main" hx-target="#content-div" hx-trigger="submit"
                    hx-indicator="#content-loader" hx-swap="innerHTML" class="flex items-center w-full group">

                    <input type="text" name="query"
                        class="block ml-2 w-full  py-1.5 pl-3 pr-4 leading-normal rounded-md focus:border-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 ring-opacity-90 bg-gray-100 dark:bg-gray-800 text-gray-400 aa-input"
                        placeholder="product query" />
                    <input type="text" name="lead_url"
                        class="block ml-2 w-full py-1.5 pl-3 pr-4 leading-normal rounded-md focus:border-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 ring-opacity-90 bg-gray-100 dark:bg-gray-800 text-gray-400 aa-input"
                        placeholder="ideal customer website" />

                        <select name="country"
                        class="ml-2 pl-2 block w-20 py-1.5 leading-normal rounded-md focus:border-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 ring-opacity-90 bg-gray-100 dark:bg-gray-800 text-gray-400"
                        aria-label="Country Code">

                    <option value="">all</option>
                    <option value="US">United States</option>
                    <option value="CA">Canada</option>
                    <option value="GB">United Kingdom</option>
                    <option value="AU">Australia</option>
                    <option value="FR">France</option>
                    <option value="DE">Germany</option>
                    <option value="IT">Italy</option>
                    <option value="ES">Spain</option>
                    <option value="BR">Brazil</option>
                    <option value="CN">China</option>
                    <option value="IN">India</option>
                    <option value="RU">Russia</option>
                    <option value="JP">Japan</option>
                    <option value="ZA">South Africa</option>
                    <option value="NG">Nigeria</option>
                    <option value="KE">Kenya</option>
                    <option value="MX">Mexico</option>
                    <option value="SG">Singapore</option>
                    <option value="NZ">New Zealand</option>
                    <option value="SE">Sweden</option>
                    <option value="NO">Norway</option>
                    <option value="FI">Finland</option>
                    <option value="DK">Denmark</option>
                    <option value="IS">Iceland</option>
                    <option value="AR">Argentina</option>
                    <option value="CL">Chile</option>
                    <option value="PE">Peru</option>
                    <option value="CO">Colombia</option>
                    <option value="VE">Venezuela</option>
                    <option value="MY">Malaysia</option>
                    <option value="TH">Thailand</option>
                    <option value="VN">Vietnam</option>
                    <option value="PH">Philippines</option>
                    <option value="ID">Indonesia</option>
                    <option value="EG">Egypt</option>
                    <option value="SA">Saudi Arabia</option>
                    <option value="IR">Iran</option>
                    <option value="TR">Turkey</option>
                    <option value="IE">Ireland</option>
                    <option value="PL">Poland</option>
                    <option value="KR">South Korea</option>
                    <option value="NL">Netherlands</option>
                    <option value="BE">Belgium</option>
                    <option value="LU">Luxembourg</option>
                    <option value="PT">Portugal</option>
                    <option value="GR">Greece</option>
                    <option value="CZ">Czech Republic</option>
                    <option value="AT">Austria</option>
                    <option value="HU">Hungary</option>
                    <option value="SK">Slovakia</option>
                    <option value="SI">Slovenia</option>
                    <option value="HR">Croatia</option>
                    <option value="BA">Bosnia and Herzegovina</option>
                    <option value="MK">North Macedonia</option>
                    <option value="BG">Bulgaria</option>
                    <option value="RO">Romania</option>
                    <option value="RS">Serbia</option>
                    <option value="MT">Malta</option>
                    <option value="CY">Cyprus</option>
                    <option value="GE">Georgia</option>
                    <option value="UA">Ukraine</option>
                    <option value="BY">Belarus</option>
                    <option value="MD">Moldova</option>
                    <option value="AM">Armenia</option>
                    <option value="AZ">Azerbaijan</option>
                    <option value="KZ">Kazakhstan</option>
                    <option value="UZ">Uzbekistan</option>
                    <option value="TM">Turkmenistan</option>
                    <option value="TJ">Tajikistan</option>
                    <option value="KG">Kyrgyzstan</option>
                    <option value="MN">Mongolia</option>
                    <!-- Add more options as needed -->
                </select>

                    <input name="city" type="text"
                        class="ml-2 block w-40 py-1.5 pl-4 pr-4 leading-normal rounded-md focus:border-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 ring-opacity-90 bg-gray-100 dark:bg-gray-800 text-gray-400"
                        placeholder="City" />
                    <button type="submit"
                        class="ml-1 px-4 py-1.5 text-xs w-60 leading-normal bg-gray-400 hover:bg-gray-500 text-white font-bold rounded-md focus:outline-none focus:shadow-outline"
                        type="button">Find leads!</button>
                </form>
            </div>
        </header>

        <!-- <div id="loading-spinner" class="hidden" role="status"> -->
        <div id="loading-spinner" class="hidden flex justify-center items-center" role="status" style="height: 100%; min-height: 200px;">
            <div class="flex items-center justify-center h-screen">
                <div class="relative">
                    <div class="h-24 w-24 rounded-full border-t-8 border-b-8 border-gray-200"></div>
                    <div class="absolute top-0 left-0 h-24 w-24 rounded-full border-t-8 border-b-8 border-blue-500 animate-spin">
                    </div>
                </div>
            </div>
        </div>

        <table id="loading-table" class="w-full text-sm text-left text-gray-500 rounded-lg">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3">
                        <input type="checkbox" id="select-all" class="cursor-pointer">
                    </th>
                    <th scope="col" class="px-6 py-3">Score</th>
                    <!-- <th scope="col" class="px-6 py-3">Did they sell {{ project.product }}</th> -->
                    <th scope="col" class="px-6 py-3">Name</th>
                    <th scope="col" class="px-6 py-3">Link</th>
                    <th scope="col" class="px-6 py-3">Categories</th>
                    <th scope="col" class="px-6 py-3">ca</th>
                    <th scope="col" class="px-6 py-3">nb employee</th>
                    <th scope="col" class="px-6 py-3">Email</th>
                    <th scope="col" class="px-6 py-3">LinkedIn</th>
                    <th scope="col" class="px-6 py-3">Instagram</th>
                    <th scope="col" class="px-6 py-3">Facebook</th>
                </tr>
            </thead>
            <tbody>
                {% for project in projects %}
                <tr class="bg-white border-b">
                    <td class="px-6 py-4">
                        <input type="checkbox" name="selected_item" value="{{ project.id }}" class="cursor-pointer">
                        <!-- Assuming each project has an ID -->
                    </td>
                    <td class="px-6 py-4">{{ project.stars }}</td>
                    <!-- <td class="px-6 py-4">{{ project.answer }}</td> -->

                    <th scope="row" class="px-6 py-4 font-medium text-gray-900">{{ project.name }}</th>

                    <td class="px-6 py-4">
                        <a target="_blank" href="{{ project.url }}" class="text-blue-600 hover:underline">{{ project.url }}</a>
                    </td>

                    <td class="px-6 py-4">{{ project.categories }}</td>
                    <td class="px-6 py-4">{{ project.ca }}</td>
                    <td class="px-6 py-4">{{ project.nb_employee }}</td>

                    <td class="px-6 py-4">{{ project.email }}</td>

                    {% if project.linkedin %}
                    <td class="px-6 py-4">
                        <a target="_blank" href="{{ project.linkedin }}" class="text-blue-600 hover:underline">

                            <img src="{% static 'images/linkedin.png' %}" alt="" class="w-5 h-5" />
                        </a>
                    </td>
                    {% else %}
                    <td class="px-6 py-4">-</td>
                    {% endif %}

                    {% if project.instagram %}
                    <td class="px-6 py-4">
                        <a target="_blank" href="{{ project.instagram }}" class="text-blue-600 hover:underline">
                            <img src="{% static 'images/instagram.webp' %}" alt="" class="w-5 h-5" />
                        </a>
                    </td>
                    {% else %}
                    <td class="px-6 py-4">-</td>
                    {% endif %}

                    {% if project.facebook %}
                    <td class="px-6 py-4">
                        <a target="_blank" href="{{ project.facebook }}" class="text-blue-600 hover:underline">
                            <img src="{% static 'images/facebook.png' %}" alt="" class="w-5 h-5" />
                        </a>
                    </td>
                    {% else %}
                    <td class="px-6 py-4">-</td>
                    {% endif %}

                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="text-right mt-4 pr-4">
            <button id="exportButton" class="btn btn-success ml-2 mb-2 px-4 py-1.5 text-xs w-40 leading-normal bg-gray-400 hover:bg-gray-500 text-white font-bold rounded-md focus:outline-none focus:shadow-outline">Export to Excel</button>
        </div>
    </div>
</div>
{% endblock content %}



<script>

document.body.addEventListener('htmx:beforeRequest', function() {
    document.getElementById('loading-spinner').classList.remove('hidden');
    document.getElementById('loading-table').classList.add('hidden');
});

document.body.addEventListener('htmx:afterRequest', function() {
    document.getElementById('loading-spinner').classList.add('hidden');
    document.getElementById('loading-table').classList.remove('hidden');
});


document.getElementById('exportButton').addEventListener('click', function() {
    var table = document.getElementById('loading-table');
    var rows = table.querySelectorAll('tbody tr');
    var data = [['Score', 'Name', 'Link', 'Categories', 'Ca', 'Nb Employee', 'Email' ,'LinkedIn', 'Instagram', 'Facebook']]; // Headers

    rows.forEach(row => {
        var score = row.cells[1].innerText.trim();
        var name = row.cells[2].innerText.trim();
        var link = row.cells[3].querySelector('a')?.href.trim() ?? '';
        var categories = row.cells[4].innerText.trim();
        var ca = row.cells[5].innerText.trim();
        var nb_employee = row.cells[6].innerText.trim();
        var email = row.cells[7].innerText.trim();
        var linkedInUrl = row.cells[8].querySelector('a')?.href.trim() ?? '';
        var instagramUrl = row.cells[9].querySelector('a')?.href.trim() ?? '';
        var facebookUrl = row.cells[10].querySelector('a')?.href.trim() ?? '';

        data.push([score, name, link, categories, ca, nb_employee, email, linkedInUrl, instagramUrl, facebookUrl]);
    });

    var ws = XLSX.utils.aoa_to_sheet(data);
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Leads");

    // If you want CSV, you can use XLSX.write with type:'csv'
    XLSX.writeFile(wb, "Leads.csv", {bookType: 'csv'});
    // XLSX.writeFile(wb, "Leads.xlsx");
});


</script>

<style>

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

.animate-spin {
    animation: spin 1s linear infinite;
}
</style>