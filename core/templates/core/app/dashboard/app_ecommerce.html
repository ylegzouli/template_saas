{% block content %}
{% load static %}

<!-- <div class="shadow-sm bg-white rounded-sm"> -->
    <div class="relative w-full h-screen overflow-x-auto rounded-lg">

        <header class="items-center w-full bg-white shadow-sm rounded-lg pt-1 pb-1 mb-3 pt-3 pb-3">
            <!-- Existing search input and buttons -->
            <div class="relative z-20 flex flex-col justify-center h-full p-2 mx-auto flex-center">
                <form id="searchForm" hx-get="/app/e-commerce" hx-target="#content-div" hx-trigger="submit"
                    hx-indicator="#content-loader" hx-swap="innerHTML" class="flex items-center w-full group">

                    <input type="text" name="query"
                        class="block ml-2 w-1/3 py-1.5 pl-3 rounded-md focus:border-transparent focus:outline-none focus:ring-1 focus:ring-black ring-opacity-90 bg-gray-100 dark:bg-gray-800 text-gray-400 aa-input"
                        placeholder="Product" />
                    <!-- <input type="text" name="lead_url"
                        class="block ml-2 w-2/3 py-1.5 pl-3 pr-4 leading-normal rounded-md focus:border-transparent focus:outline-none focus:ring-1 focus:ring-black ring-opacity-90 bg-gray-100 dark:bg-gray-800 text-gray-400 aa-input"
                        placeholder="Ideal Customer Website" /> -->

                    <select name="country"
                        class="ml-2 pl-2 block w-32 py-1.5 leading-normal rounded-md focus:border-transparent focus:outline-none focus:ring-1 focus:ring-black ring-opacity-90 bg-gray-100 dark:bg-gray-800 text-gray-400"
                        aria-label="Country Code">

                    <option value="">Country</option>
                    <option value="US">United States</option>
                    <option value="CA">Canada</option>
                    <option value="GB">United Kingdom</option>
                    <option value="AU">Australia</option>
                    <option value="FR">France</option>
                    <option value="DE">Germany</option>
                    <option value="IT">Italy</option>
                    <option value="ES">Spain</option>
                    <option value="BR">Brazil</option>
                    <option value="CN">China</option>
                    <option value="IN">India</option>
                    <option value="RU">Russia</option>
                    <option value="JP">Japan</option>
                    <option value="ZA">South Africa</option>
                    <option value="NG">Nigeria</option>
                    <option value="KE">Kenya</option>
                    <option value="MX">Mexico</option>
                    <option value="SG">Singapore</option>
                    <option value="NZ">New Zealand</option>
                    <option value="SE">Sweden</option>
                    <option value="NO">Norway</option>
                    <option value="FI">Finland</option>
                    <option value="DK">Denmark</option>
                    <option value="IS">Iceland</option>
                    <option value="AR">Argentina</option>
                    <option value="CL">Chile</option>
                    <option value="PE">Peru</option>
                    <option value="CO">Colombia</option>
                    <option value="VE">Venezuela</option>
                    <option value="MY">Malaysia</option>
                    <option value="TH">Thailand</option>
                    <option value="VN">Vietnam</option>
                    <option value="PH">Philippines</option>
                    <option value="ID">Indonesia</option>
                    <option value="EG">Egypt</option>
                    <option value="SA">Saudi Arabia</option>
                    <option value="IR">Iran</option>
                    <option value="TR">Turkey</option>
                    <option value="IE">Ireland</option>
                    <option value="PL">Poland</option>
                    <option value="KR">South Korea</option>
                    <option value="NL">Netherlands</option>
                    <option value="BE">Belgium</option>
                    <option value="LU">Luxembourg</option>
                    <option value="PT">Portugal</option>
                    <option value="GR">Greece</option>
                    <option value="CZ">Czech Republic</option>
                    <option value="AT">Austria</option>
                    <option value="HU">Hungary</option>
                    <option value="SK">Slovakia</option>
                    <option value="SI">Slovenia</option>
                    <option value="HR">Croatia</option>
                    <option value="BA">Bosnia and Herzegovina</option>
                    <option value="MK">North Macedonia</option>
                    <option value="BG">Bulgaria</option>
                    <option value="RO">Romania</option>
                    <option value="RS">Serbia</option>
                    <option value="MT">Malta</option>
                    <option value="CY">Cyprus</option>
                    <option value="GE">Georgia</option>
                    <option value="UA">Ukraine</option>
                    <option value="BY">Belarus</option>
                    <option value="MD">Moldova</option>
                    <option value="AM">Armenia</option>
                    <option value="AZ">Azerbaijan</option>
                    <option value="KZ">Kazakhstan</option>
                    <option value="UZ">Uzbekistan</option>
                    <option value="TM">Turkmenistan</option>
                    <option value="TJ">Tajikistan</option>
                    <option value="KG">Kyrgyzstan</option>
                    <option value="MN">Mongolia</option>
                    <!-- Add more options as needed -->
                </select>

                    <input name="city" type="text"
                        class="ml-2  block w-30 py-1.5 pl-4 pr-4 text-md leading-normal rounded-md focus:border-transparent focus:outline-none focus:ring-1 focus:ring-black ring-opacity-90 bg-gray-100 dark:bg-gray-800 text-gray-400"
                        placeholder="City" />

                <select name="revenue"
                    class="ml-2 block w-40 py-1.5 pl-2 pr-4 leading-normal rounded-md focus:border-transparent focus:outline-none focus:ring-1 focus:ring-black ring-opacity-90 bg-gray-100 dark:bg-gray-800 text-gray-400"
                    aria-label="Sales revenue">
                    <option value="">Sales revenue</option>
                    <option value="0-50k">0-50k</option>
                    <option value="50k-2M">50k-2M</option>
                    <option value="2M-10M">2M-10M</option>
                    <option value="10M-50M">10M-50M</option>
                    <option value="+50M">+50M</option>
                </select>
               
                <select name="results"
                class="ml-2 block w-40 py-1.5 pl-2 pr-4 leading-normal rounded-md focus:border-transparent focus:outline-none focus:ring-1 focus:ring-black ring-opacity-90 bg-gray-100 dark:bg-gray-800 text-gray-400"
                aria-label="Nb results">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
                <option value="1000">1000</option>
                </select>


                    <button type="submit"
                        class="ml-3 px-4 py-1.5 w-64 leading-normal bg-black hover:bg-gray-800 text-white rounded-md focus:outline-none focus:shadow-outline"
                        type="button">🔎 Find leads!</button>
                </form>
            </div>
        </header>



        <div id="loading-spinner" class="hidden flex justify-center items-center" role="status" style="height: 100%; min-height: 200px;">
            <div class="flex items-center justify-center h-screen">
                <div class="relative">
                    <div class="h-24 w-24 rounded-full border-t-8 border-b-8 border-gray-200"></div>
                    <div class="absolute top-0 left-0 h-24 w-24 rounded-full border-t-8 border-b-8 border-blue-500 animate-spin">
                        
                    </div>
                    
                </div>
            </div>
        </div>



        {% if projects %}
        <div class="rounded-lg w-full h-3/4 overflow-x-auto">
            <div class="rounded-lg">
              <table id="loading-table" class="w-full divide-y-2 divide-gray-200 bg-white text-sm">
                <thead class="ltr:text-left rtl:text-right">
                  <tr>
                    <th class="whitespace-nowrap px-4 py-2 font-l text-gray-900">
                        <input type="checkbox" id="select-all" class="cursor-pointer">
                    </th>
                    <th class="whitespace-nowrap px-4 py-2 border-l font-l text-gray-900">Score</th>
                    <th class="whitespace-nowrap px-4 py-2 border-l font-l text-gray-900">
                        <input type="text" class="column-search focus:border-transparent focus:outline-none focus:ring-1 focus:ring-black ring-opacity-90" data-column-index="3" placeholder="Name">
                    </th>
                    <th class="whitespace-nowrap px-4 py-2 border-l font-l text-gray-900">
                        <input type="text" class="column-search focus:border-transparent focus:outline-none focus:ring-1 focus:ring-black ring-opacity-90" data-column-index="4" placeholder="Categories">
                    </th>
                    <th class="whitespace-nowrap px-4 py-2 border-l font-l text-gray-900">Type</th>
                    <th class="whitespace-nowrap px-4 py-2 border-l font-l text-gray-900">LinkedIn</th>
                    <th class="whitespace-nowrap px-4 py-2 border-l font-l text-gray-900">Instagram</th>
                    <th class="whitespace-nowrap px-4 py-2 border-l font-l text-gray-900">Facebook</th>
                    <th class="whitespace-nowrap px-4 py-2 border-l font-l text-gray-900">Email</th>
                    <th class="whitespace-nowrap px-4 py-2 border-l font-l text-gray-900">Phones</th>
                    <th class="whitespace-nowrap px-4 py-2 border-l font-l text-gray-900">CA</th>
                    <th class="whitespace-nowrap px-4 py-2 border-l font-l text-gray-900">Nb employee</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  <!-- Dynamic row generation starts here -->
                  {% for project in projects %}
                  <tr>
                    <td class="whitespace-nowrap px-4 py-2 font-medium text-gray-900">
                        <input type="checkbox" name="selected_item" value="{{ project.id }}" class="cursor-pointer">
                    </td>
                    <td class="whitespace-nowrap  border-l px-4 py-2 font-medium text-gray-900">{{ project.stars }}</td>
                    <td class="whitespace-nowrap border-l  px-4 py-2 font-medium text-gray-900">
                        <a href="{{ project.url }}" target="_blank" class="text-blue-800 hover:text-gray-600">{{ project.name }}</a>
                      </td>
                      
                    <td class="whitespace-nowrap border-l  px-4 py-2 text-gray-700">{{ project.categories }}</td>
                    <td class="whitespace-nowrap  border-l px-4 py-2 font-medium text-gray-900">{{ project.store_type }}</td>
                    
                    <td class="whitespace-nowrap border-l  px-4 py-2 text-gray-700">
                      {% if project.linkedin %}
                      <a href="{{ project.linkedin }}" target="_blank" class="text-blue-600 hover:underline">
                            <img src="{% static 'images/linkedin_logo.png' %}" alt="" class="w-5 h-5" />
                      </a>
                      {% else %}
                      -
                      {% endif %}
                    </td>
                    <td class="whitespace-nowrap border-l  px-4 py-2 text-gray-700">
                      {% if project.instagram %}
                      <a href="{{ project.instagram }}" target="_blank" class="text-blue-600 hover:underline">
                            <img src="{% static 'images/instagram.webp' %}" alt="" class="w-5 h-5" />
                        </a>
                      {% else %}
                      -
                      {% endif %}
                    </td>


                    <td class="whitespace-nowrap border-l  px-4 py-2 text-gray-700">
                      {% if project.facebook %}
                      <a href="{{ project.facebook }}" target="_blank" class="text-blue-600 hover:underline">
                            <img src="{% static 'images/facebook.png' %}" alt="" class="w-5 h-5" />
                      </a>
                      {% else %}
                      -
                      {% endif %}
                    </td>
                    <td class="whitespace-nowrap border-l  px-4 py-2 text-gray-700">
                        {% for email in project.email %}
                            {{ email }}</br>
                        {% endfor %}
                    </td>

                    <td class="whitespace-nowrap border-l  px-4 py-2 text-gray-700">
                        {% if project.phone %}
                            {% for phone in project.phone %}
                                {{ phone }}</br>
                        {% endfor %}
                        {% else %}
                            -
                        {% endif %}
                      </td>


                    <td class="whitespace-nowrap border-l  px-4 py-2 text-gray-700">{{ project.ca }}</td>
                    <td class="whitespace-nowrap border-l  px-4 py-2 text-gray-700">{{ project.nb_employee }}</td>
                  </tr>
                  {% endfor %}
                  <!-- Dynamic row generation ends here -->
                </tbody>
              </table>
            </div>
            <!-- Pagination or other features can be added here as needed, similar to the provided design -->
          </div>            

          <div class="flex justify-between items-center mt-4 px-4 bg-white shadow-sm rounded-lg pt-1 pb-1 mb-3 pt-4 pb-4">
            <!-- Score Form on the Left -->
            <div>
                <form id="scoreForm" class="flex items-end">
                    {% csrf_token %}
                    <input type="text" name="lead_url" class="py-1.5 pl-3 pr-4 w-96 rounded-md bg-gray-100 text-gray-400 focus:ring-1 focus:ring-black focus:border-transparent focus:outline-none" placeholder="Ideal Customer Website" />
                    <button id="startTaskButton" type="submit" class="ml-2 px-4 py-1.5 bg-black text-white rounded-md hover:bg-gray-800">Score ⭐</button>
                </form>
            </div>
        
            <!-- Other Buttons on the Right -->
            <div>
                <button id="clearCacheButton" hx-get="/app/e-commerce" hx-params="clear_cache" hx-target="#content-div" hx-trigger="click" hx-swap="innerHTML" class="px-4 py-1.5 w-32 bg-white hover:bg-gray-800 hover:text-white rounded-md focus:outline-none focus:shadow-outline border border-black">
                    Clear 🚿
                </button>
                <button id="exportButton" class="w-48 ml-2 px-4 py-1.5 w-32 bg-white hover:bg-gray-800 hover:text-white rounded-md focus:outline-none focus:shadow-outline border border-black">
                    Export Selection 💾 
                </button>
            </div>
        </div>
        

    {% endif %}
    <!-- <button id="startTaskButton">Start Task</button>
    <div id="taskStatus">Task status will appear here.</div>    
    </div> -->
<!-- </div> -->
    <div role="button"
        id="reloadViewTrigger" 
        hx-get="/app/e-commerce"
        hx-params="hx_menu_request" 
        hx-push-url="true" 
        hx-target="#content-div" 
        hx-swap="innerHTML"
        hx-indicator="#content-div"
        style="display:none;"></div>
{% endblock content %}



<script>

document.body.addEventListener('htmx:beforeRequest', function() {
    document.getElementById('loading-spinner').classList.remove('hidden');
    document.getElementById('loading-table').classList.add('hidden');
});

document.body.addEventListener('htmx:afterRequest', function() {
    document.getElementById('loading-spinner').classList.add('hidden');
    document.getElementById('loading-table').classList.remove('hidden');
});


document.getElementById('exportButton').addEventListener('click', function() {
    var table = document.getElementById('loading-table');
    // Corrected the first row for column names to match your table structure
    var data = [['Score', 'Name', 'Link','Categories', 'Type', 'LinkedIn', 'Instagram', 'Facebook', 'Email', 'Phones', 'CA', 'Nb Employee']];

    // Get all rows in the table body
    var rows = table.querySelectorAll('tbody tr');

    rows.forEach(row => {
        // Check if the row's checkbox is checked
        var isSelected = row.querySelector('input[type="checkbox"]').checked;

        if (isSelected) {
            // Adjusted according to the correct order and method of getting data
            var score = row.cells[1].innerText.trim();
            var name = row.cells[2].querySelector('a') ? row.cells[2].querySelector('a').innerText.trim() : ''; // Name
            var link = row.cells[2].querySelector('a') ? row.cells[2].querySelector('a').href.trim() : '';
            var categories = row.cells[3].innerText.trim();
            var types = row.cells[4].innerText.trim();
            var linkedInUrl = row.cells[5].querySelector('a') ? row.cells[5].querySelector('a').href.trim() : '';
            var instagramUrl = row.cells[6].querySelector('a') ? row.cells[6].querySelector('a').href.trim() : '';
            var facebookUrl = row.cells[7].querySelector('a') ? row.cells[7].querySelector('a').href.trim() : '';
            var email = row.cells[8].innerText.trim().replace(/\s+/g, ', '); // Assuming emails are separated by whitespace/new lines
            var phone = row.cells[9].innerText.trim().replace(/\s+/g, ', '); // Assuming phones are separated by whitespace/new lines
            var ca = row.cells[10].innerText.trim();
            var nb_employee = row.cells[11].innerText.trim();

            // Add this row's data to the export array
            data.push([score, name, link, categories, types, linkedInUrl, instagramUrl, facebookUrl, email, phone, ca, nb_employee]);
        }
    });

    // Proceed to generate and download the CSV file
    var ws = XLSX.utils.aoa_to_sheet(data);
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Leads");
    XLSX.writeFile(wb, "Leads.csv", {bookType: 'csv'});
});


document.getElementById('select-all').addEventListener('change', function() {
    var selectAllChecked = this.checked; // Check the state of the "select-all" checkbox
    var checkboxes = document.querySelectorAll('input[name="selected_item"]'); // Get all checkboxes with the name "selected_item"

    checkboxes.forEach(function(checkbox) {
        checkbox.checked = selectAllChecked; // Set the checked state of each checkbox to match the "select-all" checkbox
    });
});


</script>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>

$(document).ready(function() {
    if (localStorage.getItem('taskInProgress') === 'true') {
        var jobId = localStorage.getItem('jobId'); // Assume you store jobId when starting the task
        if (jobId) {
            lockButtons();
            checkTaskStatus(jobId);
        } else {
            // If there's no job ID, it means there's no valid task running
            localStorage.removeItem('taskInProgress');
            unlockButtons();
        }
    }

    $('#startTaskButton').click(function(event) {
        event.preventDefault();
        startTask();
    });
});

function startTask() {
    // Simulate starting a task on the server
    $.ajax({
        url: '/start_task/', // Adjust URL to your task starting endpoint
        type: 'POST',
        data: $('#scoreForm').serialize(),
        success: function(response) {
            if (response.job_id) {
                localStorage.setItem('taskInProgress', 'true');
                localStorage.setItem('jobId', response.job_id); // Store the job ID for status checks
                lockButtons();
                checkTaskStatus(response.job_id);
            } else {
                alert("Failed to start task. Please try again.");
            }
        },
        error: function() {
            alert("An error occurred. Please try again.");
            unlockButtons();
        }
    });
}

function checkTaskStatus(jobId) {
    $.ajax({
        url: `/check_task_status/${jobId}`, // Adjust URL to your task status checking endpoint
        success: function(response) {
            if (response.status === 'pending') {
                // If the task is not yet completed, keep polling
                setTimeout(function() { checkTaskStatus(jobId); }, 5000); // Poll every 5 seconds
            } else {
                finishTask();
            }
        },
        error: function() {
            alert("Failed to check task status. Will try again.");
            setTimeout(function() { checkTaskStatus(jobId); }, 5000); // Retry after a delay
        }
    });
}

function finishTask() {
    localStorage.removeItem('taskInProgress');
    localStorage.removeItem('jobId'); // Clear the stored job ID
    unlockButtons();
    $('#reloadViewTrigger').click();
}

function lockButtons() {
    $('#startTaskButton, #searchForm button[type="submit"], #clearCacheButton').prop('disabled', true).text("Processing...");
}

function unlockButtons() {
    $('#startTaskButton').html('Score ⭐').prop('disabled', false);
    $('#searchForm button[type="submit"]').text('🔎 Find leads!').prop('disabled', false);
    $('#clearCacheButton').text('Clear 🚿').prop('disabled', false);
}


</script>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Attach a keyup event listener to each search input
        document.querySelectorAll('.column-search').forEach(function(input) {
            input.addEventListener('keyup', function() {
                var columnIndex = this.getAttribute('data-column-index');
                var filter = this.value.toUpperCase();
                var table = document.getElementById('loading-table');
                var rows = table.getElementsByTagName('tr');
    
                // Loop through all rows of the table, starting from the first data row
                for (var i = 2; i < rows.length; i++) { // Assuming first 2 rows are header rows
                    var cell = rows[i].getElementsByTagName('td')[columnIndex-1]; // Adjust index for zero-based array
                    if (cell) {
                        var cellText = cell.textContent || cell.innerText;
                        if (cellText.toUpperCase().indexOf(filter) > -1) {
                            rows[i].style.display = "";
                        } else {
                            rows[i].style.display = "none";
                        }
                    }
                }
            });
        });
    });
    </script>

<style>

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

.animate-spin {
    animation: spin 1s linear infinite;
}
</style>